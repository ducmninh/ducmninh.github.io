<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>R√∫t L√¨ X√¨ T·∫øt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --tet-red-dark: #8b0000;
      --tet-red: #b30000;
      --tet-red-light: #d61b1b;
      --tet-gold: #ffcc33;
      --tet-gold-dark: #ff9900;
      --text-color: #fffbe6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      background: radial-gradient(circle at top, #ff4444 0, #5a0000 55%, #2d0000 100%);
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url("tet-background.svg") center/cover no-repeat;
      opacity: 1;
      pointer-events: none;
      z-index: -2;
    }

    .container {
      width: 100%;
      max-width: 900px;
      background: transparent;
      padding: 20px;
      position: relative;
      overflow: visible;
    }

    .game-area {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 160px);
    }

    .title-section {
      text-align: center;
      width: 100%;
    }

    .title-section h1 {
      margin: 0;
      font-size: 2rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--tet-gold);
      text-shadow: 0 0 15px rgba(0, 0, 0, 0.8),
        0 0 25px rgba(255, 204, 51, 0.8);
    }

    .title-section p {
      margin: 8px 0 0;
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .control-bar {
      display:flex;
      gap:8px;
      justify-content:center;
      margin-top:10px;
      align-items:center;
    }

    .envelopes-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      justify-items: center;
      justify-content: center;
      align-content: center;
      place-items: center;
    }

    /* 6 √¥ l√° d√πng ·∫£nh bao l√¨ x√¨ Shopee */
    .envelope-card {
      width: 140px;
      height: 260px;
      border-radius: 12px;
      background-color: transparent;
      border: 2px solid rgba(0,0,0,0.06);
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
      user-select: none;
      background-image: url('https://down-vn.img.susercontent.com/file/vn-11134207-7ras8-m3t0xulz3em431');
      background-size: cover;
      background-position: center top;
      background-repeat: no-repeat;
    }

    .envelope-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        linear-gradient(135deg, transparent 50%, rgba(0, 0, 0, 0.35) 51%),
        radial-gradient(circle at top, rgba(255, 255, 255, 0.12), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.4; /* gi·∫£m b·ªõt ƒë·ªÉ v·∫´n th·∫•y hoa vƒÉn */
      pointer-events: none;
    }

    .envelope-card:hover:not(.opened) {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 12px 25px rgba(255, 204, 51, 0.4);
      filter: brightness(1.05);
    }

    .envelope-card:active:not(.opened) {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
    }

    .envelope-card.opened {
      opacity: 0.5;
      cursor: default;
      pointer-events: none;
    }

    .envelope-inner {
      position: relative;
      z-index: 2;
      text-align: center;
    }

    .envelope-icon {
      display: none;
    }

    .envelope-text {
      display: none;
    }

    /* Overlay hi·ªán s·ªë ti·ªÅn & l·ªùi ch√∫c l√™n tr√™n bao */
    .card-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 8px;
      gap: 6px;
      color: #fff;
      pointer-events: none;
      background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.55));
      z-index: 3;
      border-radius: 10px;
    }

    .card-overlay .card-amount {
      font-size: 1.15rem;
      font-weight: 900;
      color: var(--tet-gold);
      text-shadow: 0 0 6px rgba(0,0,0,0.7);
    }

    .card-overlay .card-greeting {
      font-size: 0.85rem;
      opacity: 0.95;
      max-width: 92%;
    }

    /* Khi modal bao d√πng m·∫∑t ph·∫£i */
    .modal-bao-right {
      background-position: center top !important;
      background-size: cover !important;
    }

    @keyframes baoPop {
      0% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
      40% { transform: scale(1.08) rotate(-2deg); filter: drop-shadow(0 14px 18px rgba(255,200,0,0.12)); }
      70% { transform: scale(0.98) rotate(1deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    .modal-bao-opening {
      animation: baoPop 320ms cubic-bezier(.2,.9,.2,1);
      box-shadow: 0 18px 60px rgba(255,200,0,0.28);
    }

    @keyframes sparkle {
      0% { opacity: 0; transform: scale(0.6); }
      50% { opacity: 1; transform: scale(1.08); }
      100% { opacity: 0; transform: scale(1.6); }
    }

    .modal-sparkle {
      position: absolute;
      left: 50%; top: 40%; transform: translate(-50%,-50%);
      width: 140px; height: 140px; border-radius: 50%; pointer-events:none; mix-blend-mode:screen; opacity:0;
      background: radial-gradient(circle at center, rgba(255,244,200,0.95), rgba(255,200,50,0.6) 40%, transparent 60%);
      animation: sparkle 600ms ease-out;
      z-index: 2025;
    }

    .btn-saved {
      background-color: #28a745 !important;
      color: #fff !important;
      border-color: #218838 !important;
      box-shadow: 0 6px 14px rgba(40,167,69,0.18);
    }

    /* Khi b·ªã g·∫Øn class no-art th√¨ v·∫´n d√πng ·∫£nh Shopee lu√¥n */
    .no-art .envelope-card {
      background-image: url('https://down-vn.img.susercontent.com/file/vn-11134207-7ras8-m3t0xulz3em431') !important;
      background-size: cover;
      background-position: center top;
      background-repeat: no-repeat;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      color:#fff;
    }

    #modalBao.modal-no-art {
      background-image: url('https://down-vn.img.susercontent.com/file/vn-11134207-7ras8-m3t0xulz3em431') !important;
      background-size: cover !important;
      background-position: center top !important;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .modal-bao-fallback { font-size:64px; pointer-events:none; filter:drop-shadow(0 10px 18px rgba(0,0,0,0.45)); }

    /* R∆°i qu√† */
    .raining-container {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 1000;
    }

    .raining-gift {
      position: absolute;
      top: -40px;
      font-size: 20px;
      opacity: 0.95;
      animation-name: fall;
      animation-timing-function: linear;
      animation-iteration-count: 1;
    }

    @keyframes fall {
      0% { transform: translateY(-20px) rotate(0deg); opacity: 0.95; }
      100% { transform: translateY(110vh) rotate(360deg); opacity: 0.95; }
    }

    .result-panel {
      background: linear-gradient(145deg, rgba(179, 0, 0, 0.96), rgba(214, 27, 27, 0.98));
      border-radius: 20px;
      border: 2px solid var(--tet-gold);
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.5), 0 0 40px rgba(255, 204, 51, 0.28);
      padding: 25px;
      width: 100%;
      max-width: 500px;
      text-align: center;
      position: relative;
    }

    .result-panel h2 {
      margin: 0 0 15px 0;
      font-size: 1.4rem;
      color: var(--tet-gold);
      letter-spacing: 1px;
    }

    .result-amount {
      font-size: 2rem;
      font-weight: 800;
      color: var(--tet-gold);
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.8), 0 0 16px rgba(255, 204, 51, 0.8);
      margin: 15px 0;
    }

    .result-message {
      font-size: 1rem;
      opacity: 0.9;
      margin: 10px 0 0;
    }

    .stats-section {
      margin-top: 20px;
      padding: 12px 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      border: 1px solid rgba(255, 204, 51, 0.3);
    }

    .stats-row {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 10px;
    }

    .stats-row:last-child {
      margin-bottom: 0;
    }

    .stat-item {
      text-align: center;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--tet-gold);
    }

    .button-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .btn-reset {
      padding: 10px 25px;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      border: 1px solid var(--tet-gold);
      background: transparent;
      color: var(--tet-gold);
      cursor: pointer;
      opacity: 0.9;
      transition: background 0.15s ease, color 0.15s ease, transform 0.08s ease;
    }

    .btn-reset:hover {
      background: rgba(255, 204, 51, 0.15);
      transform: translateY(-2px);
    }

    .btn-reset:active {
      transform: translateY(0);
      opacity: 0.8;
    }

    .container::before,
    .container::after {
      content: "";
      position: absolute;
      border: 2px solid rgba(255, 204, 51, 0.45);
      border-radius: 18px;
      inset: 6px;
      pointer-events: none;
    }

    .container::after {
      inset: 12px;
      border-color: rgba(255, 204, 51, 0.2);
    }

    .running-text {
      position: fixed;
      top: 20px;
      left: 0;
      width: 100%;
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--tet-gold);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      z-index: 999;
      white-space: nowrap;
      text-align: center;
    }

    .sound-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--tet-gold), var(--tet-gold-dark));
      border: 2px solid rgba(255, 204, 51, 0.5);
      color: #5a0000;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, filter 0.2s ease;
      z-index: 1000;
    }

    .sound-toggle:hover {
      transform: scale(1.1);
      filter: brightness(1.05);
    }

    .sound-toggle:active {
      transform: scale(0.95);
    }

    .sound-toggle.muted {
      opacity: 0.6;
    }

    @keyframes moveGiftForward {
      0% {
        transform: translateX(-100px);
        opacity: 0;
      }
      5% {
        opacity: 1;
      }
      95% {
        opacity: 1;
      }
      100% {
        transform: translateX(calc(100vw + 100px));
        opacity: 0;
      }
    }

    @keyframes moveGiftBackward {
      0% {
        transform: translateX(calc(100vw + 100px));
        opacity: 0;
      }
      5% {
        opacity: 1;
      }
      95% {
        opacity: 1;
      }
      100% {
        transform: translateX(-100px);
        opacity: 0;
      }
    }

    .moving-gifts {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 500;
      overflow: hidden;
    }

    .gift-box {
      position: absolute;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      animation: moveGiftForward linear infinite;
    }

    .gift-box:nth-child(1) {
      top: 15%;
      animation: moveGiftForward 8s linear infinite;
      animation-delay: 0s;
    }

    .gift-box:nth-child(2) {
      top: 30%;
      animation: moveGiftBackward 10s linear infinite;
      animation-delay: 2s;
    }

    .gift-box:nth-child(3) {
      top: 45%;
      animation: moveGiftForward 9s linear infinite;
      animation-delay: 4s;
    }

    .gift-box:nth-child(4) {
      top: 60%;
      animation: moveGiftBackward 11s linear infinite;
      animation-delay: 1s;
    }

    .gift-box:nth-child(5) {
      top: 75%;
      animation: moveGiftForward 8.5s linear infinite;
      animation-delay: 3s;
    }

    .gift-box:nth-child(6) {
      top: 20%;
      animation: moveGiftBackward 10s linear infinite;
      animation-delay: 5s;
    }

    .gift-box:nth-child(7) {
      top: 50%;
      animation: moveGiftForward 9.5s linear infinite;
      animation-delay: 0.5s;
    }

    .gift-box:nth-child(8) {
      top: 70%;
      animation: moveGiftBackward 11s linear infinite;
      animation-delay: 2.5s;
    }

    .history-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .history-list li {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
      border-bottom: 1px dotted rgba(255, 255, 255, 0.12);
      font-size: 0.85rem;
    }

    .history-list li:last-child {
      border-bottom: none;
    }

    .history-amount {
      font-weight: 600;
      color: var(--tet-gold);
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      .running-text {
        top: 10px;
        font-size: 1rem;
      }
      .container {
        max-width: 100%;
        padding: 15px 12px 18px;
      }
      .envelope-card {
        width: 120px;
        height: 210px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 8px;
        align-items: flex-start;
        padding-top: 28px;
      }

      .game-area {
        justify-content: flex-start;
        min-height: auto;
        padding-top: 6px;
      }

      .running-text {
        display:none;
      }

      .container {
        padding: 12px 10px 15px;
        max-height: calc(100vh - 80px);
        overflow-y: auto;
      }

      .envelopes-grid {
        grid-template-columns: repeat(3,1fr);
        gap:10px;
        max-width:100%;
        margin:6px 0;
      }

      .envelope-card {
        width: 96px;
        height: 180px;
      }

      .moving-gifts {
        display:none;
      }

      .sound-toggle {
        width:40px;
        height:40px;
        bottom:12px;
        right:12px;
        font-size:1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Modal bao l√¨ x√¨ -->
  <div id="lixiModal" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; z-index:2000;">
    <div style="position:absolute; inset:0; background:rgba(0,0,0,0.5);"></div>
    <div style="position:relative; width:320px; max-width:90%; border-radius:14px; overflow:hidden; box-shadow:0 20px 50px rgba(0,0,0,0.6); background:linear-gradient(180deg,#d93a3a,#9b1414); color:var(--text-color); z-index:2010;">
      <div style="padding:18px; text-align:center; position:relative;">
        <button id="modalResetBtn" aria-label="Ch·ªçn l·∫°i" style="position:absolute; left:12px; top:10px; height:32px; border-radius:6px; border:none; background:rgba(255,255,255,0.06); color:var(--text-color); font-weight:700; cursor:pointer; padding:6px 10px;">Ch·ªçn l·∫°i</button>
        <button id="modalChangeBtn" aria-label="ƒê√≥ng" style="position:absolute; right:12px; top:10px; width:36px; height:36px; border-radius:50%; border:none; background:rgba(255,255,255,0.08); color:var(--text-color); font-weight:700; cursor:pointer;">‚úñ</button>
        <div style="font-size:1.05rem; opacity:0.95; margin-bottom:6px;">Ho√†n Tr·∫£</div>

        <!-- Bao trong modal: c≈©ng d√πng ·∫£nh Shopee -->
        <div id="modalBao" role="button" tabindex="0" style="
          display:inline-block;
          margin-top:10px;
          width:180px;
          height:320px;
          border-radius:12px;
          background-image:url('https://down-vn.img.susercontent.com/file/vn-11134207-7ras8-m3t0xulz3em431');
          background-size:cover;
          background-position:center top;
          box-shadow:0 14px 40px rgba(0,0,0,0.45);
          cursor:default;
          position:relative;
          overflow:hidden;
          touch-action:none;">
          <!-- Flap k√©o -->
          <div id="modalFlap" style="position:absolute; left:0; right:0; top:0; height:84px; background:rgba(0,0,0,0.35); border-bottom:6px solid rgba(0,0,0,0.25); box-shadow:0 6px 10px rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; font-size:1.05rem; touch-action:none; cursor:grab;">
            <span style="transform:translateY(2px);">M·ªû L√å X√å</span>
          </div>
          <div id="modalAmountContainer" style="position:absolute; left:0; right:0; top:72px; bottom:0; display:flex; align-items:center; justify-content:center;">
            <div id="modalAmount" style="background:rgba(255,255,255,0.92); border-radius:18px; padding:12px 22px; font-weight:800; color:#b85a00; font-size:1.25rem; opacity:0; transition:opacity 160ms;">---</div>
          </div>
        </div>

        <div id="modalHint" style="margin-top:12px; font-size:0.95rem; opacity:0.95;">K√©o m√©p tr√™n ƒë·ªÉ m·ªü l√¨ x√¨</div>
        <div id="modalGreeting" style="margin-top:10px; font-size:0.95rem; opacity:0; transition:opacity 220ms; font-weight:700; color:#fff;"></div>
        <div style="font-size:0.78rem; opacity:0.9; margin-top:8px;">2026 &nbsp; L√¨ x√¨ may m·∫Øn</div>
      </div>
    </div>
  </div>

  <div class="moving-gifts" id="movingGifts"></div>
  <div class="running-text">üßß Ch√∫c M·ª´ng NƒÉm M·ªõi 2026 üßß C·∫£ nƒÉm ph√°t t√†i üí∞ üßß</div>

  <button class="sound-toggle muted" id="soundToggle" title="B·∫≠t/T·∫Øt nh·∫°c">üîá</button>

  <iframe id="tetYouTube" width="0" height="0" src="" frameborder="0" allow="autoplay"></iframe>
  <audio id="tetAudio" src="nhac.mp3" preload="auto" loop></audio>

  <div class="container">
    <div class="game-area">
      <div class="title-section">
        <h1>üßß R√∫t L√¨ X√¨ T·∫øt üßß</h1>
        <p>Nh·∫•p v√†o m·ªôt trong 6 bao ƒë·ªÉ r√∫t l√¨ x√¨ may m·∫Øn</p>
        <div class="control-bar">
          <button id="toggleRainBtn" class="btn btn-sm btn-outline-light" type="button">T·∫Øt r∆°i</button>
          <button id="btnResetGameSmall" class="btn btn-sm btn-outline-warning" type="button">R√∫t l·∫°i</button>
          <button id="showHelpBtn" class="btn btn-sm btn-outline-info" type="button">H∆∞·ªõng d·∫´n</button>
        </div>
      </div>

      <div class="envelopes-grid" id="envelopesGrid"></div>

      <div class="result-panel" id="resultPanel" style="display:none;">
        <h2>K·∫øt Qu·∫£ R√∫t L√¨ X√¨</h2>
        <div class="result-amount" id="resultAmount">---</div>
        <div class="result-message" id="resultMessage">Ch√∫c b·∫°n r√∫t ƒë∆∞·ª£c th·∫≠t nhi·ªÅu l·ªôc!</div>

        <div class="stats-section">
          <div class="stats-row">
            <div class="stat-item">
              <div class="stat-label">T·ªïng s·ªë l·∫ßn r√∫t:</div>
              <div class="stat-value" id="totalDraws">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">T·ªïng ti·ªÅn nh·∫≠n:</div>
              <div class="stat-value" id="totalAmount">0ƒë</div>
            </div>
          </div>

          <div class="stats-row">
            <div style="width:100%;">
              <div class="stat-label">L·ªãch s·ª≠ r√∫t g·∫ßn ƒë√¢y:</div>
              <ul class="history-list" id="historyList"></ul>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button class="btn-reset" id="btnResetGame">R√∫t L·∫°i</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script>
    const rewards = [
      { label: "88.888ƒë",  value: 88888,  weight: 6},
      { label: "68.686ƒë",  value: 68686,  weight: 7 },
      { label: "63.636ƒë",  value: 63636,  weight: 14 },
      { label: "50.000ƒë",  value: 50000,  weight: 14 },
      { label: "83.000ƒë",  value: 83000,  weight: 6 },
      { label: "86.000ƒë",  value: 86000,  weight: 6 },
      { label: "100.000ƒë", value: 100000, weight: 4 },
      { label: "200.000ƒë", value: 200000, weight: 2 }
    ];

    const soundToggle   = document.getElementById("soundToggle");
    const tetYouTube    = document.getElementById("tetYouTube");
    const tetAudio      = document.getElementById("tetAudio");
    const resultAmount  = document.getElementById("resultAmount");
    const resultMessage = document.getElementById("resultMessage");
    const totalDrawsEl  = document.getElementById("totalDraws");
    const totalAmountEl = document.getElementById("totalAmount");
    const historyList   = document.getElementById("historyList");
    const resultPanel   = document.getElementById("resultPanel");
    const envelopesGrid = document.getElementById("envelopesGrid");
    const btnResetGame  = document.getElementById("btnResetGame");
    const toggleRainBtn = document.getElementById("toggleRainBtn");
    const btnResetGameSmall = document.getElementById("btnResetGameSmall");
    const showHelpBtn   = document.getElementById("showHelpBtn");

    const lixiModal     = document.getElementById("lixiModal");
    const modalBao      = document.getElementById("modalBao");
    const modalHint     = document.getElementById("modalHint");
    const modalAmountEl = document.getElementById("modalAmount");
    const modalGreeting = document.getElementById("modalGreeting");
    const modalFlap     = document.getElementById("modalFlap");

    let pendingIndex = null;
    let pendingReward = null;
    let baoDragging = false;
    let baoStartY = 0;
    let baoCurrentY = 0;
    let BAO_THRESHOLD = 80;

    const YT_URL = "https://www.youtube.com/embed/ZfzxnNsOIh0?autoplay=1&loop=1&playlist=ZfzxnNsOIh0";

    let totalDraws = 0;
    let totalAmount = 0;
    let soundEnabled = false;
    let openedEnvelopes = new Set();
    let isDrawing = false;
    let rainingEnabled = true;

    function getEnvelopeCount() { return 6; }

    function createEnvelopes() {
      const count = getEnvelopeCount();
      envelopesGrid.innerHTML = "";
      for (let i = 0; i < count; i++) {
        const envelope = document.createElement("div");
        envelope.className = "envelope-card";
        envelope.dataset.index = i;
        envelope.innerHTML = `
          <div class="envelope-inner">
            <div class="envelope-icon">üßß</div>
            <div class="envelope-text">L√¨ X√¨</div>
          </div>
        `;
        envelope.addEventListener("click", () => {
          if (openedEnvelopes.has(i) || isDrawing || pendingIndex !== null) return;
          const reward = weightedRandomReward();
          pendingIndex = i;
          pendingReward = reward;
          modalAmountEl.textContent = reward.label;
          adjustThresholdForScreen();
          lixiModal.style.display = "flex";
          modalHint.textContent = "K√©o l√™n ƒë·ªÉ m·ªü l√¨ x√¨";
          modalFlap.style.transition = "transform 250ms ease";
          modalFlap.style.transform = "translateY(0px) rotate(0deg)";
          modalAmountEl.style.opacity = 0;
          modalGreeting.textContent = "";
          modalGreeting.style.opacity = 0;
        });
        envelopesGrid.appendChild(envelope);
      }
    }

    function formatCurrency(vnd) {
      return vnd.toLocaleString("vi-VN") + "ƒë";
    }

    function weightedRandomReward() {
      const totalWeight = rewards.reduce((s, it) => s + it.weight, 0);
      let r = Math.random() * totalWeight;
      for (const item of rewards) {
        if (r < item.weight) return item;
        r -= item.weight;
      }
      return rewards[0];
    }

    function addToHistory(reward) {
      const li = document.createElement("li");
      const time = new Date();
      const timeText = time.toLocaleTimeString("vi-VN", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
      });
      const spanAmount = document.createElement("span");
      spanAmount.className = "history-amount";
      spanAmount.textContent = reward.label;
      const spanTime = document.createElement("span");
      spanTime.textContent = timeText;
      li.appendChild(spanAmount);
      li.appendChild(spanTime);
      historyList.insertBefore(li, historyList.firstChild);
      while (historyList.children.length > 20) {
        historyList.removeChild(historyList.lastChild);
      }
    }

    function resetGame() {
      totalDraws = 0;
      totalAmount = 0;
      openedEnvelopes.clear();
      isDrawing = false;
      document.querySelectorAll(".envelope-card").forEach(card => {
        card.classList.remove("opened");
        card.style.transform = "";
        card.style.opacity = "1";
        const ov = card.querySelector(".card-overlay");
        if (ov) ov.remove();
      });
      resultPanel.style.display = "none";
      resultAmount.textContent = "---";
      resultMessage.textContent = "Ch√∫c b·∫°n r√∫t ƒë∆∞·ª£c th·∫≠t nhi·ªÅu l·ªôc!";
      totalDrawsEl.textContent = "0";
      totalAmountEl.textContent = "0ƒë";
      historyList.innerHTML = "";
      modalBao.style.backgroundImage = "url('https://down-vn.img.susercontent.com/file/vn-11134207-7ras8-m3t0xulz3em431')";
    }

    function adjustThresholdForScreen() {
      if (window.innerWidth <= 480 || ('ontouchstart' in window && window.innerWidth <= 768)) {
        BAO_THRESHOLD = 50;
      } else BAO_THRESHOLD = 80;
    }

    function closeModal() {
      pendingIndex = null;
      pendingReward = null;
      lixiModal.style.display = "none";
      modalBao.style.backgroundImage = "url('https://down-vn.img.susercontent.com/file/vn-11134207-7ras8-m3t0xulz3em431')";
      modalBao.classList.remove('modal-bao-right','modal-bao-opening');
      const sp = modalBao.querySelector('.modal-sparkle');
      if (sp) sp.remove();
      modalGreeting.textContent = "";
      modalGreeting.style.opacity = 0;
    }

    function openEnvelopeWithReward(index, reward) {
      if (openedEnvelopes.has(index) || isDrawing) return;
      openedEnvelopes.add(index);
      isDrawing = true;
      const card = document.querySelector(`[data-index="${index}"]`);
      if (card) {
        card.style.transform = "scale(0.8) rotateY(180deg)";
        card.style.opacity = "0.7";
        const overlay = document.createElement('div');
        overlay.className = 'card-overlay';
        const amountEl = document.createElement('div');
        amountEl.className = 'card-amount';
        amountEl.textContent = reward.label;
        const greetingsSmall = [
          'Ch√∫c b·∫°n nhi·ªÅu may m·∫Øn nƒÉm m·ªõi! üéâ',
          'Minh ch√∫c b·∫°n NƒÉm m·ªõi an khang th·ªãnh v∆∞·ª£ng! üå∏',
          'C·∫£ nƒÉm ph√°t t√†i, v·∫°n s·ª± hanh th√¥ng! üí∞',
          'Ch√∫c b·∫°n s·ª©c kh·ªèe v√† h·∫°nh ph√∫c! ü•≥'
        ];
        const greetingsBig = [
          'Wow! Tr√∫ng l·ªõn ‚Äî c·∫£ nƒÉm ph√°t t√†i! üí∏',
          'Si√™u may m·∫Øn! Ch√∫c b·∫°n b·ªôi thu! üéä',
          'Gi·ªØ l·∫•y may m·∫Øn n√†y, nƒÉm sau l·∫°i r·ªßng r·ªânh! üßß'
        ];
        const bigPrize = reward.value >= 100000;
        const pool = bigPrize ? greetingsBig : greetingsSmall;
        const greetingText = pool[Math.floor(Math.random() * pool.length)];
        const greetingEl = document.createElement('div');
        greetingEl.className = 'card-greeting';
        greetingEl.textContent = greetingText;
        overlay.appendChild(amountEl);
        overlay.appendChild(greetingEl);
        const existing = card.querySelector('.card-overlay');
        if (existing) existing.remove();
        card.appendChild(overlay);
      }

      setTimeout(() => {
        if (card) card.classList.add("opened");

        totalDraws += 1;
        totalAmount += reward.value;
        totalDrawsEl.textContent = totalDraws.toString();
        totalAmountEl.textContent = formatCurrency(totalAmount);
        resultAmount.textContent = reward.label;

        const bigPrize = reward.value >= 100000;
        if (bigPrize) {
          resultMessage.textContent = "Ch√∫c m·ª´ng! B·∫°n tr√∫ng l√¨ x√¨ l·ªõn, c·∫£ nƒÉm ph√°t t√†i üí∞";
          triggerConfetti(2);
        } else {
          resultMessage.textContent = "Ch√∫c m·ª´ng! Minh ch√∫c cho b·∫°n nƒÉm m·ªõi th·∫≠t an l√†nh üéä";
          triggerConfetti(1);
        }

        addToHistory(reward);
        resultPanel.style.display = "block";
        isDrawing = false;
      }, 400);
    }

    // Flap drag
    if (modalFlap) {
      modalFlap.addEventListener('pointerdown', (ev) => {
        ev.preventDefault();
        baoDragging = true;
        baoStartY = ev.clientY;
        modalFlap.setPointerCapture(ev.pointerId);
        modalFlap.style.transition = '';
      });

      modalFlap.addEventListener('pointermove', (ev) => {
        if (!baoDragging) return;
        const dy = Math.max(0, baoStartY - ev.clientY);
        baoCurrentY = dy;
        const translateY = -Math.min(dy, 180);
        const rot = Math.min(8, dy / 12);
        modalFlap.style.transform = `translateY(${translateY}px) rotate(${rot}deg)`;
        const showRatio = Math.min(1, dy / BAO_THRESHOLD);
        modalAmountEl.style.opacity = showRatio;
      });

      modalFlap.addEventListener('pointerup', (ev) => {
        if (!baoDragging) return;
        baoDragging = false;
        try { modalFlap.releasePointerCapture(ev.pointerId); } catch (e) {}
        if (baoCurrentY > BAO_THRESHOLD && pendingIndex !== null && pendingReward) {
          modalFlap.style.transition = 'transform 260ms cubic-bezier(.2,.9,.2,1)';
          modalFlap.style.transform = 'translateY(-200px) rotate(-6deg)';
          modalAmountEl.style.opacity = 1;

          const bigPrize = pendingReward.value >= 100000;
          const greetingText = bigPrize
            ? "Ch√∫c m·ª´ng! B·∫°n tr√∫ng l√¨ x√¨ l·ªõn, c·∫£ nƒÉm ph√°t t√†i üí∞"
            : "Ch√∫c m·ª´ng! Minh ch√∫c b·∫°n NƒÉm m·ªõi an khang th·ªãnh v∆∞·ª£ng üéä";
          modalGreeting.textContent = greetingText;
          modalGreeting.style.opacity = 1;

          setTimeout(() => {
            // D√πng c√πng ·∫£nh cho m·∫∑t ph·∫£i
            modalBao.style.backgroundImage =
              "url('https://down-vn.img.susercontent.com/file/vn-11134207-7ras8-m3t0xulz3em431')";
            modalBao.classList.add('modal-bao-right','modal-bao-opening');
            const sparkle = document.createElement('div');
            sparkle.className = 'modal-sparkle';
            modalBao.appendChild(sparkle);
            setTimeout(() => {
              modalBao.classList.remove('modal-bao-opening');
              if (sparkle && sparkle.parentNode) sparkle.parentNode.removeChild(sparkle);
            }, 800);

            openEnvelopeWithReward(pendingIndex, pendingReward);
            if (navigator && typeof navigator.vibrate === 'function') {
              try { navigator.vibrate(60); } catch (e) {}
            }
          }, 260);
        } else {
          modalFlap.style.transition = 'transform 240ms cubic-bezier(.2,.9,.2,1)';
          modalFlap.style.transform = 'translateY(0px) rotate(0deg)';
          modalAmountEl.style.opacity = 0;
        }
        baoCurrentY = 0;
      });

      lixiModal.addEventListener('click', (ev) => {
        if (ev.target === lixiModal) closeModal();
      });
    }

    document.getElementById('modalResetBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      closeModal();
    });
    document.getElementById('modalChangeBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      closeModal();
    });

    function triggerConfetti(intensity = 1) {
      const duration = 3000 * intensity;
      confetti({
        particleCount: Math.floor(120 * intensity),
        spread: 120,
        origin: { x: 0.5, y: 0.5 },
        colors: ["#ff2d2d", "#ffcc33", "#ff9900", "#fffbe6", "#00ff00", "#ff00ff"],
        ticks: Math.floor(duration / 16),
        gravity: 0.8,
        decay: 0.95
      });
    }

    function startMusic() {
      if (soundEnabled) return;
      soundEnabled = true;
      if (tetAudio && tetAudio.src) {
        const p = tetAudio.play();
        if (p && typeof p.then === 'function') {
          p.catch(() => { tetYouTube.src = YT_URL; });
        }
      } else tetYouTube.src = YT_URL;
      soundToggle.classList.remove("muted");
      soundToggle.textContent = "üîä";
    }

    function stopMusic() {
      soundEnabled = false;
      try {
        if (tetAudio && !tetAudio.paused) {
          tetAudio.pause();
          tetAudio.currentTime = 0;
        }
      } catch (e) {}
      tetYouTube.src = "";
      soundToggle.classList.add("muted");
      soundToggle.textContent = "üîá";
    }

    soundToggle.addEventListener("click", () => {
      if (soundEnabled) stopMusic();
      else startMusic();
    });

    btnResetGame.addEventListener("click", resetGame);
    btnResetGameSmall.addEventListener("click", (e) => { e.preventDefault(); resetGame(); });

    function createRainingGifts(intensity = 8) {
      const container = document.createElement('div');
      container.className = 'raining-container';
      container.id = 'rainingContainer';
      document.body.appendChild(container);
      const emojis = ['üéÅ','üéä','üéâ','üßß','‚ú®','üíù'];
      const max = Math.max(3, Math.min(18, intensity));
      for (let i = 0; i < max; i++) spawnOne();
      function spawnOne() {
        const el = document.createElement('div');
        el.className = 'raining-gift';
        el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        el.style.left = (Math.random()*100) + 'vw';
        const size = 14 + Math.floor(Math.random()*18);
        el.style.fontSize = size + 'px';
        const dur = 3 + Math.random()*6;
        el.style.animationDuration = dur + 's';
        el.style.animationDelay = (Math.random()*2) + 's';
        container.appendChild(el);
        el.addEventListener('animationend', () => {
          el.remove();
          setTimeout(spawnOne, 400 + Math.random()*3000);
        });
      }
    }

    function startRaining(intensity) {
      if (document.getElementById('rainingContainer')) return;
      createRainingGifts(intensity);
      rainingEnabled = true;
      toggleRainBtn.textContent = 'T·∫Øt r∆°i';
    }

    function stopRaining() {
      const c = document.getElementById('rainingContainer');
      if (c) c.remove();
      rainingEnabled = false;
      toggleRainBtn.textContent = 'B·∫≠t r∆°i';
    }

    toggleRainBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (rainingEnabled) stopRaining();
      else startRaining(window.innerWidth <= 480 ? 4 : 10);
    });

    showHelpBtn.addEventListener('click', (e) => {
      e.preventDefault();
      alert('H∆∞·ªõng d·∫´n:\n1) B·∫•m v√†o m·ªôt bao l√¨ x√¨.\n2) K√©o m√©p tr√™n trong h·ªôp hi·ªán ra ƒë·ªÉ m·ªü.\n3) B·∫•m Ch·ªçn l·∫°i n·∫øu mu·ªën ch·ªçn bao kh√°c.');
    });

    function createMovingGifts() {
      const giftsContainer = document.getElementById("movingGifts");
      const giftEmojis = ["üéÅ", "üéÄ", "üéä", "üéâ", "üíù", "üßß"];
      for (let i = 0; i < 8; i++) {
        const giftBox = document.createElement("div");
        giftBox.className = "gift-box";
        giftBox.textContent = giftEmojis[i % giftEmojis.length];
        giftsContainer.appendChild(giftBox);
      }
    }

    let lastEnvelopeCount = getEnvelopeCount();

    window.addEventListener("load", () => {
      lastEnvelopeCount = getEnvelopeCount();
      createEnvelopes();
      createMovingGifts();
      const intensity = window.innerWidth <= 480 ? 4 : 10;
      if (window.innerWidth > 420) startRaining(intensity);
      setTimeout(startMusic, 500);
      setTimeout(() => triggerConfetti(1.2), 800);
    });

    window.addEventListener("resize", () => {
      const newCount = getEnvelopeCount();
      if (newCount !== lastEnvelopeCount) {
        lastEnvelopeCount = newCount;
        createEnvelopes();
      }
    });

    document.addEventListener("click", function firstClick() {
      if (!soundEnabled) startMusic();
      document.removeEventListener("click", firstClick);
    }, { once: true });
  </script>
</body>
</html>
